name: FFT Multi-Language CI

on:
  push:
    branches: [ main, master, copilot/** ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    name: Test All Languages
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    # Python setup
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    # Node.js setup (for JavaScript and TypeScript)
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    # Java setup
    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    # Rust setup
    - name: Set up Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
    
    # C++ is already available in ubuntu-latest
    
    # Install JavaScript/TypeScript dependencies
    - name: Install JavaScript dependencies
      working-directory: ./javascript
      run: npm install
      
    - name: Install TypeScript dependencies
      working-directory: ./typescript
      run: npm install
    
    # Run Python tests with coverage
    - name: Test Python FFT
      working-directory: ./python
      run: |
        pip install coverage
        coverage run test_fft.py
        coverage xml
    
    # Run C++ tests with coverage
    - name: Install lcov
      run: sudo apt-get install -y lcov
      
    - name: Test C++ FFT
      working-directory: ./cpp
      run: make coverage
    
    # Run Java tests with coverage
    - name: Download JaCoCo
      working-directory: ./java
      run: |
        wget -q https://repo1.maven.org/maven2/org/jacoco/jacoco/0.8.11/jacoco-0.8.11.zip
        unzip -q jacoco-0.8.11.zip
        
    - name: Test Java FFT
      working-directory: ./java
      run: |
        javac FFT.java
        javac TestFFT.java
        java -javaagent:lib/jacocoagent.jar=destfile=jacoco.exec -ea TestFFT
        java -jar lib/jacococli.jar report jacoco.exec --classfiles FFT.class --classfiles TestFFT.class --sourcefiles . --xml jacoco.xml
    
    # Run JavaScript tests with coverage
    - name: Test JavaScript FFT
      working-directory: ./javascript
      run: npm run coverage
    
    # Run TypeScript tests with coverage
    - name: Test TypeScript FFT
      working-directory: ./typescript
      run: npm run coverage
    
    # Run Rust tests with coverage
    - name: Install cargo-llvm-cov
      run: cargo install cargo-llvm-cov
      
    - name: Test Rust FFT
      working-directory: ./rust
      run: cargo llvm-cov --lcov --output-path lcov.info
    
    # Upload coverage reports to Codecov
    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./python/coverage.xml,./cpp/coverage.info,./java/jacoco.xml,./javascript/coverage/lcov.info,./typescript/coverage/lcov.info,./rust/lcov.info
        flags: python,cpp,java,javascript,typescript,rust
        name: codecov-umbrella
        fail_ci_if_error: false
        verbose: true

  benchmark:
    name: Performance Comparison
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Set up Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
    
    - name: Install TypeScript dependencies
      working-directory: ./typescript
      run: npm install
    
    - name: Run performance comparison
      run: |
        echo "## Performance Comparison (4096 samples)" > performance.md
        echo "" >> performance.md
        echo "| Language | Time (ms) |" >> performance.md
        echo "|----------|-----------|" >> performance.md
        
        # Python
        PYTHON_TIME=$(cd python && python3 test_fft.py 2>&1 | grep "4096 samples:" | awk '{print $4}')
        echo "| Python | $PYTHON_TIME |" >> performance.md
        
        # C++
        cd cpp && make > /dev/null 2>&1 && cd ..
        CPP_TIME=$(cd cpp && ./test_fft 2>&1 | grep "4096 samples:" | awk '{print $4}')
        echo "| C++ | $CPP_TIME |" >> performance.md
        
        # Java
        cd java && javac FFT.java && javac TestFFT.java && cd ..
        JAVA_TIME=$(cd java && java -ea TestFFT 2>&1 | grep "4096 samples:" | awk '{print $4}')
        echo "| Java | $JAVA_TIME |" >> performance.md
        
        # JavaScript
        JS_TIME=$(cd javascript && node test_fft.js 2>&1 | grep "4096 samples:" | awk '{print $4}')
        echo "| JavaScript | $JS_TIME |" >> performance.md
        
        # TypeScript
        TS_TIME=$(cd typescript && npm test 2>&1 | grep "4096 samples:" | awk '{print $4}')
        echo "| TypeScript | $TS_TIME |" >> performance.md
        
        # Rust
        RUST_TIME=$(cd rust && cargo run --release 2>&1 | grep "4096 samples:" | awk '{print $4}')
        echo "| Rust | $RUST_TIME |" >> performance.md
        
        cat performance.md
    
    - name: Upload performance results
      uses: actions/upload-artifact@v4
      with:
        name: performance-results
        path: performance.md
